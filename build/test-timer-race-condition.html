<!DOCTYPE html>
<html>
<head>
    <title>Timer Race Condition Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-container { max-width: 800px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; 
               white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Timer Race Condition Test</h1>
        
        <div>
            <button onclick="checkRunningTimer()">Check Running Timer</button>
            <button onclick="startTimer()">Start Timer</button>
            <button onclick="stopTimer()">Stop Timer</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <h3>Current Timer ID: <span id="timerId">None</span></h3>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        let currentTimerId = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function checkRunningTimer() {
            try {
                log('Checking for running timer...');
                const response = await fetch('/api/time-entries.php?action=check_running', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                log(`Response: ${JSON.stringify(data, null, 2)}`);
                
                if (data.hasRunningTimer && data.runningTimer) {
                    currentTimerId = data.runningTimer.id;
                    document.getElementById('timerId').textContent = currentTimerId;
                    log(`Found running timer with ID: ${currentTimerId}`, 'warning');
                } else {
                    currentTimerId = null;
                    document.getElementById('timerId').textContent = 'None';
                    log('No running timer found', 'success');
                }
            } catch (error) {
                log(`Error checking timer: ${error.message}`, 'error');
            }
        }
        
        async function startTimer() {
            try {
                log('Starting new timer...');
                const now = new Date();
                const response = await fetch('/api/time-entries.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        userId: 2, // You may need to adjust this
                        username: 'Test User',
                        date: now.toISOString().split('T')[0],
                        startTime: now.toTimeString().split(' ')[0],
                        stopTime: null,
                        location: 'Test Location',
                        role: 'Mitarbeiter',
                        updatedBy: 'Test User'
                    })
                });
                
                const data = await response.json();
                currentTimerId = data.id;
                document.getElementById('timerId').textContent = currentTimerId;
                log(`Timer started with ID: ${currentTimerId}`, 'success');
                
                // Check again after 500ms
                setTimeout(() => {
                    log('Checking timer after 500ms...', 'warning');
                    checkRunningTimer();
                }, 500);
                
            } catch (error) {
                log(`Error starting timer: ${error.message}`, 'error');
            }
        }
        
        async function stopTimer() {
            if (!currentTimerId) {
                log('No timer ID available to stop', 'error');
                return;
            }
            
            try {
                log(`Stopping timer with ID: ${currentTimerId}...`);
                const now = new Date();
                const response = await fetch('/api/time-entries.php?action=stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        id: currentTimerId,
                        stopTime: now.toTimeString().split(' ')[0],
                        updatedBy: 'Test User'
                    })
                });
                
                const data = await response.json();
                log(`Stop response: ${JSON.stringify(data, null, 2)}`, 'success');
                
                // Simulate the race condition - check immediately
                log('Checking timer immediately after stop...', 'warning');
                await checkRunningTimer();
                
                // Check again after 100ms
                setTimeout(async () => {
                    log('Checking timer after 100ms...', 'warning');
                    await checkRunningTimer();
                }, 100);
                
                // Check again after 500ms
                setTimeout(async () => {
                    log('Checking timer after 500ms...', 'warning');
                    await checkRunningTimer();
                }, 500);
                
            } catch (error) {
                log(`Error stopping timer: ${error.message}`, 'error');
            }
        }
        
        // Initial check
        checkRunningTimer();
    </script>
</body>
</html>