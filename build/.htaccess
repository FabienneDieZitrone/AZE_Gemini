# Base options (allow symlinks owned by same user; no directory listing)
Options -Indexes +SymLinksIfOwnerMatch

# ============================================================================
# SECURITY HEADERS - Global protection for all requests
# ============================================================================
<IfModule mod_headers.c>
    # Prevent clickjacking attacks
    Header always set X-Frame-Options "DENY"

    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"

    # Enable XSS protection in older browsers
    Header always set X-XSS-Protection "1; mode=block"

    # Strict Transport Security (HSTS) - Force HTTPS for 1 year
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Referrer Policy - Only send origin on cross-origin requests
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Permissions Policy - Disable unnecessary browser features
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()"

    # Content Security Policy (CSP) - Only for HTML pages
    <FilesMatch "\.(html|php)$">
        Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://login.microsoftonline.com https://graph.microsoft.com; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"
    </FilesMatch>
</IfModule>

# Protect sensitive files
<FilesMatch "\.(env|log|sql|ini|conf|cfg)$">
    Require all denied
    <IfModule mod_headers.c>
      Header always set Cache-Control "no-store"
    </IfModule>
    ExpiresActive Off
    FileETag None
    Header unset ETag
</FilesMatch>

# Protect directories
<IfModule mod_rewrite.c>
    RewriteEngine On
    # Deny direct access to internal storage folders
    RewriteRule ^(logs|data|cache)/ - [F,L]
</IfModule>

# Caching: ensure index.html is never cached; hashed assets can be cached long
<IfModule mod_headers.c>
  <Files "index.html">
    Header always set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    Header always set Pragma "no-cache"
    Header always set Expires "0"
  </Files>

  <FilesMatch "\.(js|css|svg|png|jpg|jpeg|gif|webp|woff|woff2)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
</IfModule>

# Disable ETag to avoid weak caching conflicts (safe if module allows)
<IfModule mod_headers.c>
  FileETag None
</IfModule>

# Ensure default index files (prefer index.php loader for cache-busting)
DirectoryIndex index.php index.html

# Redirect veralteter Pfad "/aze" auf die Startseite, um doppelte Verzeichnisse zu vermeiden
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteRule ^aze/?$ / [R=302,L]
</IfModule>
