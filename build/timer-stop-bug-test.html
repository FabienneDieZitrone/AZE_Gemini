<!DOCTYPE html>
<html>
<head>
    <title>Timer Stop Bug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .controls { margin: 20px 0; }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }
        .start { background: #28a745; color: white; }
        .stop { background: #dc3545; color: white; }
        .check { background: #007bff; color: white; }
        .debug { background: #6c757d; color: white; }
        .force-stop { background: #ff6b6b; color: white; }
        
        .status { 
            margin: 20px 0; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .log { 
            background: #2d2d2d; 
            color: #f0f0f0;
            padding: 15px; 
            margin: 10px 0; 
            font-family: 'Consolas', monospace; 
            font-size: 12px;
            white-space: pre-wrap; 
            max-height: 400px; 
            overflow-y: auto; 
            border-radius: 4px;
        }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd93d; }
        .info { color: #74c0fc; }
        
        .timer-list {
            margin: 20px 0;
        }
        .timer-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .timer-running {
            background: #ffebee;
            border-left: 4px solid #dc3545;
        }
        .timer-stopped {
            background: #e8f5e9;
            border-left: 4px solid #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêõ Timer Stop Bug Test</h1>
        
        <div class="status">
            <h3>Current Status</h3>
            <div>Timer ID: <strong id="currentTimerId">None</strong></div>
            <div>Timer State: <strong id="timerState">Stopped</strong></div>
            <div>Last Action: <strong id="lastAction">None</strong></div>
        </div>
        
        <div class="controls">
            <h3>Main Controls</h3>
            <button class="start" onclick="startTimer()">‚ñ∂Ô∏è Start Timer</button>
            <button class="stop" onclick="stopTimer()">‚èπÔ∏è Stop Timer</button>
            <button class="check" onclick="checkRunningTimer()">üîç Check Running Timer</button>
            <button class="check" onclick="listAllTimers()">üìã List All Timers</button>
        </div>
        
        <div class="controls">
            <h3>Debug Controls</h3>
            <button class="debug" onclick="simulateRaceCondition()">‚ö° Simulate Race Condition</button>
            <button class="force-stop" onclick="forceStopAll()">üõë Force Stop All Timers</button>
            <button class="debug" onclick="clearLog()">üóëÔ∏è Clear Log</button>
        </div>
        
        <div class="timer-list" id="timerList"></div>
        
        <h3>Event Log</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        let currentTimerId = null;
        let isTracking = false;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(timerId, state, action) {
            document.getElementById('currentTimerId').textContent = timerId || 'None';
            document.getElementById('timerState').textContent = state;
            document.getElementById('lastAction').textContent = action;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'info');
        }
        
        async function checkRunningTimer() {
            try {
                log('üîç Checking for running timer...', 'info');
                const response = await fetch('/api/time-entries.php?action=check_running', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.hasRunningTimer && data.runningTimer) {
                    currentTimerId = data.runningTimer.id;
                    isTracking = true;
                    updateStatus(currentTimerId, 'Running', 'Check found running timer');
                    log(`‚úÖ Found running timer: ID ${currentTimerId}`, 'success');
                    log(`   Started at: ${data.runningTimer.date} ${data.runningTimer.startTime}`, 'info');
                } else {
                    currentTimerId = null;
                    isTracking = false;
                    updateStatus(null, 'Stopped', 'Check found no timer');
                    log('‚úÖ No running timer found', 'success');
                }
            } catch (error) {
                log(`‚ùå Error checking timer: ${error.message}`, 'error');
            }
        }
        
        async function startTimer() {
            try {
                log('‚ñ∂Ô∏è Starting new timer...', 'info');
                const now = new Date();
                const response = await fetch('/api/time-entries.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        userId: 2, // Adjust if needed
                        username: 'Test User',
                        date: now.toISOString().split('T')[0],
                        startTime: now.toTimeString().split(' ')[0],
                        stopTime: null,
                        location: 'Test Location',
                        role: 'Mitarbeiter',
                        updatedBy: 'Test User'
                    })
                });
                
                const data = await response.json();
                currentTimerId = data.id;
                isTracking = true;
                updateStatus(currentTimerId, 'Running', 'Started timer');
                log(`‚úÖ Timer started with ID: ${currentTimerId}`, 'success');
                
                // Auto-check after start
                setTimeout(() => {
                    log('‚è±Ô∏è Auto-checking timer status after 500ms...', 'warning');
                    checkRunningTimer();
                }, 500);
                
            } catch (error) {
                log(`‚ùå Error starting timer: ${error.message}`, 'error');
            }
        }
        
        async function stopTimer() {
            if (!currentTimerId) {
                log('‚ö†Ô∏è No timer ID available to stop', 'warning');
                return;
            }
            
            try {
                log(`‚èπÔ∏è Stopping timer ID: ${currentTimerId}...`, 'info');
                const now = new Date();
                const response = await fetch('/api/time-entries.php?action=stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        id: currentTimerId,
                        stopTime: now.toTimeString().split(' ')[0],
                        updatedBy: 'Test User'
                    })
                });
                
                const data = await response.json();
                log(`‚úÖ Stop response: ${data.message}`, 'success');
                
                // Update local state
                isTracking = false;
                updateStatus(currentTimerId, 'Stopped', 'Stopped timer');
                currentTimerId = null;
                
                // SIMULATE THE RACE CONDITION
                log('üèÅ Simulating race condition checks...', 'warning');
                
                // Check 1: Immediate
                checkRunningTimer();
                
                // Check 2: After 100ms
                setTimeout(() => {
                    log('‚è±Ô∏è Checking after 100ms...', 'warning');
                    checkRunningTimer();
                }, 100);
                
                // Check 3: After 500ms
                setTimeout(() => {
                    log('‚è±Ô∏è Checking after 500ms...', 'warning');
                    checkRunningTimer();
                }, 500);
                
            } catch (error) {
                log(`‚ùå Error stopping timer: ${error.message}`, 'error');
            }
        }
        
        async function listAllTimers() {
            try {
                log('üìã Listing all timers...', 'info');
                const response = await fetch('/api/debug-timer-stop.php?action=list_timers', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                log(`Found ${data.timers.length} timers (${data.running_count} running)`, 'info');
                
                const timerListDiv = document.getElementById('timerList');
                timerListDiv.innerHTML = '<h3>Recent Timers</h3>';
                
                data.timers.forEach(timer => {
                    const isRunning = timer.status === 'RUNNING';
                    const div = document.createElement('div');
                    div.className = `timer-item ${isRunning ? 'timer-running' : 'timer-stopped'}`;
                    div.innerHTML = `
                        <div>
                            <strong>ID: ${timer.id}</strong> | 
                            ${timer.date} ${timer.start_time} - ${timer.stop_time || 'RUNNING'} | 
                            Status: <strong>${timer.status}</strong>
                        </div>
                        ${isRunning ? `<button class="stop" onclick="testStopSpecific(${timer.id})">Stop This</button>` : ''}
                    `;
                    timerListDiv.appendChild(div);
                });
                
            } catch (error) {
                log(`‚ùå Error listing timers: ${error.message}`, 'error');
            }
        }
        
        async function testStopSpecific(timerId) {
            try {
                log(`üß™ Testing stop for timer ID: ${timerId}...`, 'info');
                const response = await fetch(`/api/debug-timer-stop.php?action=test_stop&timer_id=${timerId}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                log(`Stop test result: ${data.success ? 'SUCCESS' : 'FAILED'}`, data.success ? 'success' : 'error');
                log(`Before: ${data.before.stop_time || 'NULL'} ‚Üí After: ${data.after.stop_time || 'NULL'}`, 'info');
                
                // Refresh list
                listAllTimers();
                
            } catch (error) {
                log(`‚ùå Error in stop test: ${error.message}`, 'error');
            }
        }
        
        async function forceStopAll() {
            if (!confirm('Are you sure you want to force stop ALL running timers?')) {
                return;
            }
            
            try {
                log('üõë Force stopping all timers...', 'warning');
                const response = await fetch('/api/debug-timer-stop.php?action=force_stop_all', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                log(`‚úÖ ${data.message}`, 'success');
                
                // Reset state
                currentTimerId = null;
                isTracking = false;
                updateStatus(null, 'Stopped', 'Force stopped all');
                
                // Refresh list
                listAllTimers();
                
            } catch (error) {
                log(`‚ùå Error force stopping: ${error.message}`, 'error');
            }
        }
        
        async function simulateRaceCondition() {
            log('‚ö° Starting race condition simulation...', 'warning');
            log('1Ô∏è‚É£ Starting timer...', 'info');
            await startTimer();
            
            setTimeout(async () => {
                log('2Ô∏è‚É£ Stopping timer after 1 second...', 'info');
                await stopTimer();
                
                log('3Ô∏è‚É£ Simulating immediate refresh (like refreshData())...', 'warning');
                // This simulates what happens in the React app
                setTimeout(() => {
                    log('4Ô∏è‚É£ Checking for running timer (simulating useEffect)...', 'warning');
                    checkRunningTimer();
                }, 50);
            }, 1000);
        }
        
        // Initial check
        log('üöÄ Timer Stop Bug Test initialized', 'info');
        checkRunningTimer();
        listAllTimers();
    </script>
</body>
</html>