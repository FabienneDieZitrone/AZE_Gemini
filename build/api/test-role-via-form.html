<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Role Update Test Form</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
        .form-group { margin: 10px 0; }
        label { display: inline-block; width: 150px; }
        input, select { padding: 5px; width: 300px; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
        #result { margin-top: 20px; padding: 20px; background: #222; border: 1px solid #0f0; white-space: pre-wrap; }
        .error { color: #f00; }
        .success { color: #0f0; }
    </style>
</head>
<body>
    <h1>Role Update Test Form</h1>

    <div class="form-group">
        <label>User ID:</label>
        <input type="number" id="userId" value="4">
    </div>

    <div class="form-group">
        <label>New Role:</label>
        <select id="newRole">
            <option value="Mitarbeiter">Mitarbeiter</option>
            <option value="Honorarkraft">Honorarkraft</option>
            <option value="Standortleiter">Standortleiter</option>
            <option value="Bereichsleiter" selected>Bereichsleiter</option>
            <option value="Admin">Admin</option>
        </select>
    </div>

    <button onclick="testRoleUpdate()">Test Role Update</button>
    <button onclick="checkCurrentRole()">Check Current Role</button>

    <div id="result"></div>

    <script>
        async function testRoleUpdate() {
            const userId = parseInt(document.getElementById('userId').value);
            const newRole = document.getElementById('newRole').value;
            const resultDiv = document.getElementById('result');

            resultDiv.innerHTML = 'Sending request...\n';

            try {
                const response = await fetch('/api/users.php', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ userId, newRole })
                });

                const contentType = response.headers.get('content-type');
                resultDiv.innerHTML += `\nStatus: ${response.status} ${response.statusText}\n`;
                resultDiv.innerHTML += `Content-Type: ${contentType}\n\n`;

                let responseText = await response.text();
                resultDiv.innerHTML += `Raw Response:\n${responseText}\n\n`;

                try {
                    const data = JSON.parse(responseText);
                    resultDiv.innerHTML += `Parsed JSON:\n${JSON.stringify(data, null, 2)}\n`;

                    if (response.ok) {
                        resultDiv.className = 'success';
                    } else {
                        resultDiv.className = 'error';
                    }
                } catch (e) {
                    resultDiv.innerHTML += `\nJSON Parse Error: ${e.message}\n`;
                    resultDiv.className = 'error';
                }
            } catch (error) {
                resultDiv.innerHTML = `Network Error: ${error.message}`;
                resultDiv.className = 'error';
            }
        }

        async function checkCurrentRole() {
            const userId = parseInt(document.getElementById('userId').value);
            const resultDiv = document.getElementById('result');

            try {
                const response = await fetch('/api/debug-users.php', {
                    credentials: 'include'
                });
                const text = await response.text();

                // Extract user info
                const lines = text.split('\n');
                const userLine = lines.find(line => line.includes(`ID ${userId}:`));

                if (userLine) {
                    resultDiv.innerHTML = `Current state:\n${userLine}`;
                } else {
                    resultDiv.innerHTML = `User ID ${userId} not found in debug output`;
                }
            } catch (error) {
                resultDiv.innerHTML = `Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>
