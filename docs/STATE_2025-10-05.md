# Projektzustand – 2025-10-05

Kurzfassung (Server /api, Produktion):

- Login: aktuell ein „Backup“-Login-Endpunkt aktiv (serverseitige Varianten). Startseite lädt; Zeiten waren sichtbar; zeitweise 500er durch Login-Varianten und Query-Logger – behoben.
- Approvals (Genehmigungen):
  - Neue Anträge werden laut Server-Logs gespeichert (POST_success in approvals-debug.log).
  - GET /api/approvals.php liefert (rollenbasiert):
    - Ausstehend (pending) = 0
    - Fallback für Admin/Leitung: letzte 20 Einträge – aktiv, liefert z. Z. 3 Einträge mit Status genehmigt/abgelehnt.
  - UI zeigt weiter leer, weil die verwendete Login-Variante keine approvalRequests in der Payload liefert und der FE-Build mit Umschalter nicht deployed ist.
- DB-Schema:
  - approval_requests: kein created_at; enum(type) jetzt inkl. 'create' (Migration live); entry_id nun NULL-fähig (Migration live).
  - Statuswerte live: genehmigt/abgelehnt (final). „pending“ wird offenbar aktuell nicht verwendet.
- Timer/Tracking:
  - Meldungen: „Start beginnt bei 24:00“ und „neue Zeiten werden nicht getrackt“. Im Verdacht: aktive login.php-Variante + Session-/CSRF-Interaktion mit /api/time-entries.impl.php.

Relevante Endpunkte (Server):

- /api/login.php – mehrere Varianten vorhanden; aktive Datei liefert i. d. R. basis Daten (User, ggf. Zeiten), aber nicht immer approvalRequests.
- /api/approvals.php (GET, POST, PATCH) – live angepasst:
  - GET: pending (tolerant) oder Fallback (Admin/Leitung → letzte 20). Standort per COALESCE(new_data.location, fallback original).
  - POST: schema-adaptiv (UUID/AI, requested_at/created_at, entry_id-NULL), requested_by = Session-E-Mail.
  - PATCH: genehmigt/abgelehnt + applies auf time_entries.
- /api/approvals_dump.php – Admin-Diagnose (counts + latest), Session erforderlich.

Was aktuell erklärt, warum die UI keine Genehmigungen zeigt:

1) Es gibt (derzeit) 0 ausstehende Anträge (pending=0) – alle 3 vorhandenen sind final (genehmigt/abgelehnt). Das ist korrektes Verhalten der Ansicht „Ausstehend“.
2) Die verwendete Login-Variante füllt approvalRequests nicht. Ein FE-Umschalter „Ausstehend/Alle“ ist lokal implementiert, aber nicht deployed.
3) GET /api/approvals.php liefert die 3 finalen Anträge korrekt (für Admin), aber die UI lädt diese Antwort (noch) nicht, solange der Login-Payload verwendet wird.

Sichere nächste Schritte (ohne Login zu riskieren):

1) Frontend minimal deployen:
   - Änderungen: build/api.ts (getPendingApprovals/getAllApprovals), MainAppView.tsx (laden in approvals view), ApprovalView.tsx (Umschalter + Status-Spalte).
   - Build/Deploy: `cd build && npm ci && npm run build` → dist/ deployen; UI lädt dann explizit /api/approvals.php.

2) Alternativ (kein FE-Deploy):
   - Auf Server in /api/login.php an passender Stelle approvalRequests injizieren (rollenbasiert + Fallback) – bereits punktuell umgesetzt, abhängig von aktiver login.php-Variante.

3) Tracking prüfen (Start 24:00 / Tracking stoppt):
   - Netzwerkanfragen zu /api/time-entries.impl.php (start/stop/check_running) prüfen.
   - CSRF-Bypass (Same-Origin) ist aktiv – HTTP-Status in DevTools prüfen.
   - /api/test.html (falls vorhanden) auf neue Zeilen (start/stop) prüfen.

4) Status-Mapping finalisieren:
   - Zentrale Status-Map (pending vs. final) in GET /approvals.php (und ggf. login.php) konsolidieren.

Notizen zu Änderungen (Server /api):

- approvals.php: Pending-Filter tolerant, Standort-Filter per COALESCE, Fallback für Admin/Leitung.
- approvals_dump.php: Admin-Diagnose (Statuszählung + letzte Einträge) – erfordert gültige Session.
- (Temporär) login.php: in aktiver Variante approvalRequests-Injektion ergänzt (rollenbasiert + Fallback), um die bestehende UI sofort zu versorgen.

Bekannte Risiken:

- Mehrere login.php-Varianten am Server → Verhalten hängt von der aktuell aktiven Datei ab.
- Frontend-Umschalter sind lokal implementiert, aber ohne FE-Deploy nicht sichtbar.

